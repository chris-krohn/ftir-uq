[["index.html", "Chapter 1 FTIR data assessments in collaboration with UQ 1.1 Import 1.2 Microbial 16S (V3V4) PCA 1.3 Raw spectra 1.4 Transformed spectra - centred-log ratio 1.5 Corplot", " Chapter 1 FTIR data assessments in collaboration with UQ 1.1 Import # PREPARE library(phyloseq) library(ggpubr) # a handy helper package for ggplots theme_set(theme_bw()) # setting the theme for ggplots library(microbiome) library(tidyverse) library(DT) `%notin%` &lt;- Negate(`%in%`) # MICROBIAL DATA # reading in a previously saved phyloseq object. This contains microbial 16S-ASV abundances of all samples. ps_1C &lt;- readRDS(&quot;./data/ps_215samplesJul24&quot;) # ps_1C #phyloseq-class experiment-level object #otu_table() OTU Table: [ 17961 taxa and 215 samples ] #sample_data() Sample Data: [ 215 samples by 48 sample variables ] #tax_table() Taxonomy Table: [ 17961 taxa by 7 taxonomic ranks ] #phy_tree() Phylogenetic Tree: [ 17961 tips and 17822 internal nodes ] ### Pre-filtering microbial data ps.flt &lt;- prune_taxa(taxa_sums(ps_1C) &gt;= 10, ps_1C) #m inimum reads per ASV #phyloseq-class experiment-level object #otu_table() OTU Table: [ 5855 taxa and 215 samples ] #sample_data() Sample Data: [ 215 samples by 60 sample variables ] #tax_table() Taxonomy Table: [ 5855 taxa by 7 taxonomic ranks ] #phy_tree() Phylogenetic Tree: [ 5855 tips and 5763 internal nodes ] # MASTERDATA # change this path to where you store the .csv file. you can provide an absolute path like this. Check the path syntax for Windows as it might be different. masterdata &lt;- read.csv(&quot;./data/masterdataProject1C_May24.csv&quot;) ## Change date to date format in R masterdata &lt;- masterdata %&gt;% mutate(Date = lubridate::dmy(as.character(Date)) ) # Make AD, Treatment and SludgeType = factors masterdata$AD &lt;- factor(masterdata$AD, levels = c(&quot;AD1&quot;, &quot;AD2&quot;,&quot;AD3&quot;, &quot;AD4&quot;,&quot;AD5&quot;, &quot;AD6&quot;, &quot;Full-scale&quot;, &quot;PSTWAS&quot;)) masterdata$SludgeType &lt;- factor(masterdata$SludgeType, levels = c(&quot;Control&quot;, &quot;Treatment&quot;, &quot;Foam&quot;, &quot;Full-scale&quot;, &quot;PSTWAS&quot;)) masterdata$Treatment &lt;- factor(masterdata$Treatment, levels = c(&quot;Control&quot;, &quot;Treatment&quot;, &quot;Full-scale&quot;, &quot;PSTWAS&quot;)) masterdata$Period &lt;- factor(masterdata$Period, levels = c(&quot;Converging&quot;, &quot;SteadyState&quot;, &quot;Glycerol&quot;, &quot;Inhibition&quot;, &quot;Recovery/Feedingpause&quot;, &quot;Recovery/Foaming&quot;, &quot;Recovery/Postfoam&quot;, &quot;SteadyState/Postfoam&quot;)) # LOAD REFLECTANCE DATA ATR &lt;- read.csv(&quot;./data/ADVATR.csv&quot;)[-1,] ATR &lt;- ATR %&gt;% rownames_to_column(&quot;ID&quot;)%&gt;% column_to_rownames(&quot;X&quot;) %&gt;% dplyr::select(-ID) %&gt;% mutate(across(S537_AD1:S1370_AD6, as.numeric)) # OPTION 1: raw ATR &lt;- as.matrix(ATR) head(ATR) %&gt;% datatable(caption = &quot;ATR raw&quot;) # OPTION 2: clr transformed ATRclr &lt;- compositions::clr(ATR) head(ATRclr) %&gt;% datatable(caption = &quot;ATR clr&quot;) # CREATE METADATA FOR 24 SELECTED SAMPLES AND MATCH SAMPLE NAMES WITH SPECTRA DF filtervec &lt;- c(&quot;2023-05-01&quot;, &quot;2023-05-15&quot;, &quot;2023-06-07&quot;,&quot;2023-06-12&quot;) # 12thJuneDNA = 13th June EPS filtervec2 &lt;- c(&quot;AD1&quot;, &quot;AD2&quot;, &quot;AD3&quot;, &quot;AD4&quot;, &quot;AD5&quot;,&quot;AD6&quot;) # check metadata &lt;- masterdata %&gt;% dplyr::filter(Date %in% filtervec &amp; AD %in% filtervec2) metadata$SampleID.EPS &lt;- colnames(ATR) metadata &lt;- metadata %&gt;% column_to_rownames(&quot;SampleID.EPS&quot;) head(metadata ) %&gt;% datatable(caption = &quot;metadata for 24 selected samples&quot;) # CREATE A PHYLOSEQ OBJECTS (combined metadata and spectra) psATR &lt;-phyloseq( otu_table(ATR, taxa_are_rows = T), sample_data(metadata) ) psATRclr &lt;-phyloseq( otu_table(ATRclr, taxa_are_rows = T), sample_data(metadata) ) # ABSORBANCE DATA AVE &lt;- read.csv(&quot;./data/AVE.csv&quot;)[-1,] AVE &lt;- AVE %&gt;% rownames_to_column(&quot;ID&quot;)%&gt;% column_to_rownames(&quot;X&quot;) %&gt;% dplyr::select(-ID) %&gt;% mutate(across(S537_AD1:S1370_AD6, as.numeric)) # OPTION 1: raw AVE &lt;- as.matrix(AVE) # OPTION 2: clr transformed AVEclr &lt;- compositions::clr(AVE) # head(AVEclr) # CREATE A PHYLOSEQ OBJECTS (combined metadata and spectra) psAVE &lt;-phyloseq( otu_table(AVE, taxa_are_rows = T), sample_data(metadata) ) psAVEclr &lt;-phyloseq( otu_table(AVEclr, taxa_are_rows = T), sample_data(metadata) ) 1.2 Microbial 16S (V3V4) PCA Just to see how microbial 16S abundances vary among the selected samples. We expect treated/inhibited samples (15th May) to be different. 1.3 Raw spectra 1.3.1 PCA ATR library(factoextra) library(compositions) my_comparisons &lt;- list(c(1, 2)) symbolsize &lt;- 3 ps.temp &lt;- psATR pca &lt;- prcomp(otu_table(ps.temp), scale = FALSE, center = TRUE) # summary(otu_table(ps.temp)) # head(otu_table(ps.temp)) data &lt;- get_pca(pca) cord &lt;- data$coord # extract sample coordinates of PC cor &lt;- data$cor cos2 &lt;- data$cos2 contrib &lt;- data$contrib # contributions of variables # Combine df.tmp &lt;- (data.frame(cord) %&gt;% rownames_to_column(&quot;ID&quot;)) %&gt;% left_join(sample_data(ps.temp) %&gt;% rownames_to_column(&quot;ID&quot;) ) # compare_means(Dim.1 ~ Treatment, method = &quot;t.test&quot;, df.tmp) #0.315 # compare_means(Dim.2 ~ Treatment, method = &quot;t.test&quot;, df.tmp) #0.908 # compare_means(Dim.3 ~ Treatment, method = &quot;t.test&quot;, df.tmp) #0.0075 ** # compare_means(Dim.4 ~ Treatment, method = &quot;t.test&quot;, df.tmp) #0.205 1.3.1.1 Compare variation of components Assessing if there were significant differences in the variation of Principal Components (PCs) between groups (control and treatment) 1.3.2 PCA AVE library(factoextra) library(compositions) ps.temp &lt;- psAVE # summary(otu_table(ps.temp)) pca &lt;- prcomp(data.frame(otu_table(ps.temp)), scale = FALSE, center = TRUE) # otu_table(ps.temp) data &lt;- get_pca(pca) cord &lt;- data$coord cor &lt;- data$cor cos2 &lt;- data$cos2 contrib &lt;- data$contrib df.tmp &lt;- (data.frame(cord) %&gt;% rownames_to_column(&quot;ID&quot;)) %&gt;% left_join(sample_data(ps.temp) %&gt;% rownames_to_column(&quot;ID&quot;) ) # compare_means(Dim.1 ~ Treatment, method = &quot;t.test&quot;, df.tmp) #0.133 # compare_means(Dim.2 ~ Treatment, method = &quot;t.test&quot;, df.tmp) #0.397 # compare_means(Dim.3 ~ Treatment, method = &quot;t.test&quot;, df.tmp) #0.026 * # compare_means(Dim.4 ~ Treatment, method = &quot;t.test&quot;, df.tmp) #0.502 1.3.2.1 Compare variation of components Assessing if there were significant differences in the variation of Principal Components (PCs) between groups (control and treatment) 1.3.3 Comparing ATR and AVE of PC3 1.3.4 Spectra contributions to PC3 1.4 Transformed spectra - centred-log ratio 1.4.1 PCA ATR clr library(factoextra) library(compositions) ps.temp &lt;- psATRclr pca &lt;- prcomp(otu_table(ps.temp), scale = FALSE, center = FALSE) # summary(otu_table(ps.temp)) # otu_table(ps.temp) data &lt;- get_pca(pca) cord &lt;- data$coord cor &lt;- data$cor cos2 &lt;- data$cos2 contrib &lt;- data$contrib df.tmp &lt;- (data.frame(cord) %&gt;% rownames_to_column(&quot;ID&quot;)) %&gt;% left_join(sample_data(ps.temp) %&gt;% rownames_to_column(&quot;ID&quot;) ) # compare_means(Dim.1 ~ Treatment, method = &quot;t.test&quot;, df.tmp) #0.281 # compare_means(Dim.2 ~ Treatment, method = &quot;t.test&quot;, df.tmp) #0.627 # compare_means(Dim.3 ~ Treatment, method = &quot;t.test&quot;, df.tmp) #0.00117 ** # compare_means(Dim.4 ~ Treatment, method = &quot;t.test&quot;, df.tmp) # 0.518 1.4.1.1 Compare variation of components Assessing if there were significant differences in the variation of Principal Components (PCs) between groups (control and treatment) 1.4.2 PCA AVE - clr library(factoextra) library(compositions) my_comparisons &lt;- list(c(1, 2)) ps.temp &lt;- psAVEclr # summary(otu_table(ps.temp)) pca &lt;- prcomp(data.frame(otu_table(ps.temp)), scale = FALSE, center = FALSE) # FALSE FOR BOTH - CLR data should already be centred and scaled. # otu_table(ps.temp) data &lt;- get_pca(pca) cord &lt;- data$coord cor &lt;- data$cor cos2 &lt;- data$cos2 contrib &lt;- data$contrib df.tmp &lt;- (data.frame(cord) %&gt;% rownames_to_column(&quot;ID&quot;)) %&gt;% left_join(sample_data(ps.temp) %&gt;% rownames_to_column(&quot;ID&quot;) ) # compare_means(Dim.1 ~ Treatment, method = &quot;t.test&quot;, df.tmp) #0.172 # compare_means(Dim.2 ~ Treatment, method = &quot;t.test&quot;, df.tmp) #0.708 # compare_means(Dim.3 ~ Treatment, method = &quot;t.test&quot;, df.tmp) #0.0228 * # compare_means(Dim.4 ~ Treatment, method = &quot;t.test&quot;, df.tmp) #0.613 1.4.2.1 Compare variation of components Assessing if there were significant differences in the variation of Principal Components (PCs) between groups (control and treatment) 1.4.3 Comparing ATR and AVE of PC3 1.4.4 Spectra contributions to PC3 Unsure why the clr-transformed ATR spectra resulted in such different PC3 contributions compared to clr-transformed AVE spectra. 1.5 Corplot This needs further assessments/regression etc as it was done without any consideration to data distribution / validity. library(ggcorrplot) # Compute a correlation matrix df.cor &lt;- df.tmp %&gt;% filter(ID != &quot;S963_AD6&quot;) %&gt;% # filter this sample as it has NAs dplyr::select(Dim.1, Dim.2, Dim.3, Dim.4, Dim.5, Gasflow_mL, C, H_pct, N_pct, CN, HC, Ethanol:Hexanoic.acid, ngmL_qb, DNA_mg_gCOD) corr &lt;- round(cor(df.cor, method = &quot;spearman&quot;), 1) p &lt;- ggcorrplot(corr) p + ggtitle(&quot;AVE clr correlations to variables&quot;) #ggsave(plot = p, &quot;./Figures/PC3correlations_clr.png&quot;, height=18, width=18, units=&#39;cm&#39;, dpi=300) "]]
